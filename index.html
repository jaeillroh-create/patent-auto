<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íŠ¹í—ˆëª…ì„¸ì„œ ìë™ ìƒì„± | íŠ¹í—ˆê·¸ë£¹ ë””ë”¤</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/pretendard/1.3.9/static/pretendard.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Pretendard', -apple-system, sans-serif; background: #f4f6f9; color: #1a1a1a; }

        /* Layout */
        .app { max-width: 1000px; margin: 0 auto; padding: 16px; }
        .header { text-align: center; padding: 24px 0 16px; }
        .header h1 { font-size: 24px; color: #1B3A5C; margin-bottom: 4px; }
        .header p { color: #888; font-size: 13px; }

        /* Stats Bar */
        .stats { display: flex; gap: 10px; margin-bottom: 16px; }
        .stat-box { flex: 1; text-align: center; padding: 14px 8px; border-radius: 10px; color: white; }
        .stat-box .num { font-size: 26px; font-weight: 700; }
        .stat-box .lbl { font-size: 11px; opacity: 0.9; }
        .bg1 { background: linear-gradient(135deg, #1B3A5C, #2C5F8A); }
        .bg2 { background: linear-gradient(135deg, #2C5F8A, #3A7CA5); }
        .bg3 { background: linear-gradient(135deg, #3A7CA5, #4A9CC5); }

        /* Phase Tabs */
        .phase-tabs { display: flex; gap: 4px; margin-bottom: 16px; overflow-x: auto; }
        .phase-tab {
            flex: 1; min-width: 90px; padding: 10px 6px; border-radius: 10px;
            border: 1px solid #e0e0e0; background: white; cursor: pointer;
            text-align: center; transition: all 0.2s;
        }
        .phase-tab:hover { border-color: #1B3A5C; }
        .phase-tab.active { border: 2px solid #1B3A5C; background: #EBF0F7; }
        .phase-tab .icon { font-size: 20px; }
        .phase-tab .name { font-size: 11px; font-weight: 600; margin-top: 2px; }

        /* Cards */
        .card {
            background: white; border-radius: 12px; padding: 20px;
            margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        .card.checkpoint { border: 2px solid #1B3A5C; }
        .card h3 { color: #1B3A5C; font-size: 16px; margin-bottom: 12px; }
        .card h4 { color: #333; font-size: 14px; margin: 16px 0 8px; }

        /* Buttons */
        .btn {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 10px 20px; border-radius: 8px; border: 1px solid #ccc;
            background: white; color: #333; font-weight: 600; font-size: 13px;
            cursor: pointer; transition: all 0.2s;
        }
        .btn:hover { background: #f0f0f0; }
        .btn.primary { background: #1B3A5C; color: white; border: none; }
        .btn.primary:hover { background: #153050; }
        .btn:disabled { background: #e0e0e0; color: #999; cursor: not-allowed; }
        .btn-row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; }

        /* Inputs */
        textarea, input[type="text"], input[type="password"] {
            width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd;
            font-family: inherit; font-size: 13px; line-height: 1.7; resize: vertical;
        }
        textarea:focus, input:focus { outline: none; border-color: #1B3A5C; }
        .title-input { border: 2px solid #1B3A5C; font-size: 15px; font-weight: 600; }

        /* Collapsible */
        .collapse-header {
            padding: 10px 14px; background: #f8f9fa; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
            font-weight: 600; font-size: 13px; border-radius: 8px;
            border: 1px solid #e8e8e8; margin-bottom: 4px;
        }
        .collapse-header:hover { background: #f0f2f5; }
        .collapse-body { padding: 12px; border: 1px solid #e8e8e8; border-top: none; border-radius: 0 0 8px 8px; margin-bottom: 8px; margin-top: -5px; }
        .badge { background: #4CAF50; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 500; }

        /* Issues */
        .issue { padding: 8px 12px; border-radius: 6px; margin-bottom: 6px; font-size: 13px; }
        .issue.critical { background: #FFEBEE; border-left: 4px solid #ef5350; }
        .issue.high { background: #FFF3E0; border-left: 4px solid #FF9800; }
        .issue.pass { background: #E8F5E9; border-left: 4px solid #4CAF50; }

        /* Loading */
        .spinner { display: inline-block; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Preview */
        .preview-block {
            white-space: pre-wrap; font-size: 13px; line-height: 1.8;
            padding: 12px; background: #f9f9f9; border-radius: 6px;
            max-height: 300px; overflow: auto; border: 1px solid #eee;
        }

        /* Footer */
        .footer { text-align: center; color: #bbb; font-size: 11px; padding: 20px 0; }

        /* API Key Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); display: flex; align-items: center;
            justify-content: center; z-index: 1000;
        }
        .modal {
            background: white; border-radius: 16px; padding: 32px;
            max-width: 480px; width: 90%;
        }
        .modal h2 { color: #1B3A5C; margin-bottom: 12px; }
        .modal p { color: #666; font-size: 13px; margin-bottom: 16px; line-height: 1.6; }
        .modal .hint { font-size: 12px; color: #999; margin-top: 8px; }

        /* Hide phase content */
        .phase-content { display: none; }
        .phase-content.active { display: block; }
    </style>
</head>
<body>

<div class="app" id="app">

    <!-- API Key Modal -->
    <div class="modal-overlay" id="apiModal">
        <div class="modal">
            <h2>ğŸ”‘ API Key ì„¤ì •</h2>
            <p>Anthropic API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”. í‚¤ëŠ” ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥ë˜ë©° ì™¸ë¶€ë¡œ ì „ì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
            <input type="password" id="apiKeyInput" placeholder="sk-ant-api03-..." style="margin-bottom: 12px;">
            <p class="hint">
                ë°œê¸‰: <a href="https://console.anthropic.com/settings/keys" target="_blank">console.anthropic.com</a> â†’ API Keys â†’ Create Key
            </p>
            <button class="btn primary" onclick="setApiKey()" style="width:100%; justify-content: center;">ì‹œì‘í•˜ê¸°</button>
        </div>
    </div>

    <!-- Header -->
    <div class="header">
        <h1>ğŸ“‹ íŠ¹í—ˆëª…ì„¸ì„œ ìë™ ìƒì„±</h1>
        <p>íŠ¹í—ˆê·¸ë£¹ ë””ë”¤ | 19ë‹¨ê³„ AI íŒŒì´í”„ë¼ì¸ Â· ìë™ ê²€ì¦ Â· Human-in-the-Loop</p>
    </div>

    <!-- Stats -->
    <div class="stats">
        <div class="stat-box bg1"><div class="num" id="statComplete">0/19</div><div class="lbl">ì™„ë£Œ ë‹¨ê³„</div></div>
        <div class="stat-box bg2"><div class="num" id="statCalls">0</div><div class="lbl">API í˜¸ì¶œ</div></div>
        <div class="stat-box bg3"><div class="num" id="statCost">$0.000</div><div class="lbl">ì˜ˆìƒ ë¹„ìš©</div></div>
    </div>

    <!-- Phase Tabs -->
    <div class="phase-tabs">
        <div class="phase-tab active" onclick="switchPhase(0)"><div class="icon">ğŸ“‹</div><div class="name">ê¸°ë³¸ ì •ë³´</div></div>
        <div class="phase-tab" onclick="switchPhase(1)"><div class="icon">âš–ï¸</div><div class="name">ì²­êµ¬ë²”ìœ„</div></div>
        <div class="phase-tab" onclick="switchPhase(2)"><div class="icon">ğŸ–¼ï¸</div><div class="name">ë„ë©´ & ì„¤ëª…</div></div>
        <div class="phase-tab" onclick="switchPhase(3)"><div class="icon">ğŸ”</div><div class="name">ê²€í† </div></div>
        <div class="phase-tab" onclick="switchPhase(4)"><div class="icon">ğŸ“¥</div><div class="name">ì‚°ì¶œë¬¼</div></div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â• Phase 0: ê¸°ë³¸ ì •ë³´ â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="phase-content active" id="phase0">
        <div class="card">
            <h3>ğŸ“ ë°œëª… ë‚´ìš© ì…ë ¥</h3>
            <textarea id="projectText" rows="6" placeholder="ë°œëª…ì˜ í•µì‹¬ ê¸°ìˆ , êµ¬ì„±ìš”ì†Œ, ì°¨ë³„ì , ë°ì´í„° íë¦„ ë“±ì„ ìƒì„¸íˆ ì…ë ¥í•˜ì„¸ìš”...&#10;&#10;ì˜ˆ: AI ê¸°ë°˜ìœ¼ë¡œ ê¸°ì—…ê³¼ ì •ë¶€ ì§€ì›ì‚¬ì—…ì„ ë§¤ì¹­í•˜ëŠ” í”Œë«í¼. ê¸°ì—… í”„ë¡œí•„(ì—…ì¢…, ë§¤ì¶œ, ì¸ë ¥ ë“±)ì„ ë¶„ì„í•˜ì—¬ ì í•©í•œ ì§€ì›ì‚¬ì—…ì„ ì¶”ì²œí•˜ê³ ..."></textarea>
        </div>

        <div class="card checkpoint">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <h3>ğŸ·ï¸ Step 1: ë°œëª…ì˜ ëª…ì¹­ (Checkpoint)</h3>
                <button class="btn primary" onclick="runStep('step_01')" id="btn_step_01">ğŸ¤– ëª…ì¹­ í›„ë³´ ìƒì„±</button>
            </div>
            <div id="output_step_01_preview" style="display:none; background:#f0f4f8; padding:12px; border-radius:8px; margin-bottom:10px; font-size:13px; white-space:pre-wrap; line-height:1.8;"></div>
            <input type="text" id="titleInput" class="title-input" placeholder="í™•ì •í•  ë°œëª…ì˜ ëª…ì¹­ (ìœ„ í›„ë³´ì—ì„œ ì„ íƒ ë˜ëŠ” ì§ì ‘ ì…ë ¥)" oninput="onTitleChange()">
            <div id="titleConfirm" style="display:none; color:#4CAF50; font-weight:700; margin-top:6px;">âœ… ëª…ì¹­ í™•ì •ë¨</div>
        </div>

        <div id="phase0Steps" style="display:none;">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                    <h3>ğŸ“ Step 2~5: ê¸°ë³¸ ì„¹ì…˜</h3>
                    <button class="btn primary" onclick="runBatch(['step_02','step_03','step_04','step_05'])">ğŸš€ ì¼ê´„ ìƒì„±</button>
                </div>
                <div id="step02_section"></div>
                <div id="step03_section"></div>
                <div id="step04_section"></div>
                <div id="step05_section"></div>
            </div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â• Phase 1: ì²­êµ¬ë²”ìœ„ â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="phase-content" id="phase1">
        <div class="card checkpoint">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <h3>âš–ï¸ Step 6: ì¥ì¹˜ ì²­êµ¬í•­ (Checkpoint)</h3>
                <button class="btn primary" onclick="runStep('step_06')" id="btn_step_06">ğŸ¤– ìƒì„±</button>
            </div>
            <div id="claimStats" style="display:none; margin-bottom:12px;"></div>
            <div id="claimValidation"></div>
            <div id="step06_edit"></div>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <h3>ğŸ“‹ Step 10: ë°©ë²• ì²­êµ¬í•­</h3>
                <button class="btn primary" onclick="runStep('step_10')" id="btn_step_10">ğŸ¤– ìƒì„±</button>
            </div>
            <div id="step10_edit"></div>
        </div>

        <div class="card">
            <h3>ì¶”ê°€ ì²­êµ¬í•­</h3>
            <div class="btn-row">
                <button class="btn" onclick="runStep('step_14')">ğŸ“‹ ëŒ€ì•ˆ ì²­êµ¬í•­ (Step 14)</button>
                <button class="btn" onclick="runStep('step_15')">ğŸ” ê¸°ì¬ë¶ˆë¹„ ì²´í¬ (Step 15)</button>
            </div>
            <div id="step14_section"></div>
            <div id="step15_section"></div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â• Phase 2: ë„ë©´ & ì„¤ëª… â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="phase-content" id="phase2">
        <div class="card checkpoint">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <h3>ğŸ–¼ï¸ Step 7: ë„ë©´ ì„¤ê³„ (Checkpoint)</h3>
                <button class="btn primary" onclick="runStep('step_07')" id="btn_step_07">ğŸ¤– ìƒì„±</button>
            </div>
            <div id="step07_edit"></div>
        </div>

        <div class="card">
            <h3>ğŸ“ ìƒì„¸ì„¤ëª… & ìˆ˜í•™ì‹</h3>
            <div class="btn-row">
                <button class="btn primary" onclick="runStep('step_08')" id="btn_step_08">ì¥ì¹˜ ìƒì„¸ì„¤ëª… (Step 8)</button>
                <button class="btn" onclick="runStep('step_09')" id="btn_step_09">ìˆ˜í•™ì‹ (Step 9)</button>
            </div>
            <div id="step08_section"></div>
            <div id="step09_section"></div>
        </div>

        <div class="card">
            <h3>ğŸ“Š ë°©ë²• ë„ë©´ & ì„¤ëª…</h3>
            <div class="btn-row">
                <button class="btn" onclick="runStep('step_11')" id="btn_step_11">ë°©ë²• ë„ë©´ (Step 11)</button>
                <button class="btn" onclick="runStep('step_12')" id="btn_step_12">ë°©ë²• ì„¤ëª… (Step 12)</button>
            </div>
            <div id="step11_section"></div>
            <div id="step12_section"></div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â• Phase 3: ê²€í†  â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="phase-content" id="phase3">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <h3>ğŸ” Step 13: ëª…ì„¸ì„œ ê²€í† </h3>
                <button class="btn primary" onclick="runStep('step_13')">ğŸ¤– ì „ì²´ ê²€í† </button>
            </div>
            <div id="step13_section"></div>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <h3>ğŸ“„ ë§ˆë¬´ë¦¬ ì„¹ì…˜</h3>
                <button class="btn primary" onclick="runBatch(['step_16','step_17','step_18','step_19'])">ğŸš€ ì¼ê´„ ìƒì„±</button>
            </div>
            <div id="step16_section"></div>
            <div id="step17_section"></div>
            <div id="step18_section"></div>
            <div id="step19_section"></div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â• Phase 4: ìµœì¢… ì‚°ì¶œë¬¼ â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="phase-content" id="phase4">
        <div class="card">
            <h3>ğŸ“¥ ìµœì¢… ì‚°ì¶œë¬¼</h3>
            <div class="btn-row">
                <button class="btn primary" onclick="copyFullSpec()">ğŸ“‹ ì „ì²´ ëª…ì„¸ì„œ í´ë¦½ë³´ë“œ ë³µì‚¬</button>
                <button class="btn" onclick="downloadAsText()">ğŸ’¾ TXT íŒŒì¼ ë‹¤ìš´ë¡œë“œ</button>
            </div>
            <p style="font-size:12px; color:#888; margin-bottom:16px;">ë³µì‚¬ í›„ Wordì— ë¶™ì—¬ë„£ê¸°í•˜ë©´ ë©ë‹ˆë‹¤. ì„¹ì…˜ í—¤ë”(ã€...ã€‘)ê°€ ìë™ í¬í•¨ë©ë‹ˆë‹¤.</p>
            <div id="previewArea"></div>
        </div>

        <div class="card">
            <h3>ğŸ’° API ì‚¬ìš©ëŸ‰</h3>
            <div id="usageSummary" style="font-size:13px; color:#555;"></div>
        </div>
    </div>

    <div class="footer">íŠ¹í—ˆëª…ì„¸ì„œ ìë™ ìƒì„± ì‹œìŠ¤í…œ v1.0 | íŠ¹í—ˆê·¸ë£¹ ë””ë”¤ / ì£¼ì‹íšŒì‚¬ ì‹œë„ˆì§€ì•¤ | 2026</div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// State
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let API_KEY = '';
let outputs = {};
let title = '';
let usage = { calls: 0, input: 0, output: 0 };
let loadingSteps = {};

const SYSTEM_PROMPT = `ë„ˆëŠ” 20ë…„ ê²½ë ¥ì˜ í•œêµ­ ë³€ë¦¬ì‚¬ì´ë‹¤.
íŠ¹í—ˆ ëª…ì„¸ì„œë¥¼ ì‘ì„±í•  ë•Œ ë‹¤ìŒ ì›ì¹™ì„ í•­ìƒ ì§€ì¼œë¼:
1. ë¬¸ì²´ëŠ” íŠ¹í—ˆ ëª…ì„¸ì„œì˜ í‘œì¤€ ë¬¸ì²´(~í•œë‹¤, ~ì´ë‹¤)ë¥¼ ì‚¬ìš©í•œë‹¤.
2. ë¶ˆí•„ìš”í•œ ì„œìˆ˜, ê¸€ë¨¸ë¦¬ ê¸°í˜¸, ë§ˆí¬ë‹¤ìš´ ì„œì‹ì„ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆë¼.
3. êµ¬ì²´ì  ì†Œí”„íŠ¸ì›¨ì–´ëª…/ë¼ì´ë¸ŒëŸ¬ë¦¬ëª… ëŒ€ì‹  ê¸°ìˆ ì  ì•Œê³ ë¦¬ì¦˜ í˜•íƒœë¡œ ê¸°ì¬í•œë‹¤.
4. ëª¨ë“  êµ¬ì„±ìš”ì†ŒëŠ” 'êµ¬ì„±ìš”ì†Œëª…(ì°¸ì¡°ë²ˆí˜¸)' í˜•íƒœë¡œ ê¸°ì¬í•œë‹¤.
5. ì¶œë ¥ì€ ë°”ë¡œ ëª…ì„¸ì„œì— ë¶™ì—¬ë„£ì„ ìˆ˜ ìˆëŠ” ìˆœìˆ˜ í…ìŠ¤íŠ¸ í˜•íƒœë¡œ ì‘ì„±í•œë‹¤.
6. ë§ˆí¬ë‹¤ìš´ í—¤ë”(#, ##), ë³¼ë“œ(**), ì´íƒ¤ë¦­(*) ë“± ì–´ë–¤ ë§ˆí¬ë‹¤ìš´ ì„œì‹ë„ ì‚¬ìš©í•˜ì§€ ë§ˆë¼.`;

const STEP_NAMES = {
    step_01: 'ë°œëª…ì˜ ëª…ì¹­', step_02: 'ê¸°ìˆ ë¶„ì•¼', step_03: 'ë°°ê²½ê¸°ìˆ ',
    step_04: 'ì„ í–‰ê¸°ìˆ ë¬¸í—Œ', step_05: 'í•´ê²°í•˜ê³ ì í•˜ëŠ” ê³¼ì œ', step_06: 'ì¥ì¹˜ ì²­êµ¬í•­',
    step_07: 'ë„ë©´ ì„¤ê³„', step_08: 'ì¥ì¹˜ ìƒì„¸ì„¤ëª…', step_09: 'ìˆ˜í•™ì‹',
    step_10: 'ë°©ë²• ì²­êµ¬í•­', step_11: 'ë°©ë²• ë„ë©´', step_12: 'ë°©ë²• ìƒì„¸ì„¤ëª…',
    step_13: 'ëª…ì„¸ì„œ ê²€í† ', step_14: 'ëŒ€ì•ˆ ì²­êµ¬í•­', step_15: 'ê¸°ì¬ë¶ˆë¹„ ì²´í¬',
    step_16: 'ë°œëª…ì˜ íš¨ê³¼', step_17: 'ê³¼ì œì˜ í•´ê²° ìˆ˜ë‹¨', step_18: 'ë„ë©´ ë¶€í˜¸',
    step_19: 'ìš”ì•½ì„œ'
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API Key
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setApiKey() {
    const key = document.getElementById('apiKeyInput').value.trim();
    if (!key) { alert('API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
    API_KEY = key;
    sessionStorage.setItem('patent_api_key', key);
    document.getElementById('apiModal').style.display = 'none';
}

// Check saved key
(function() {
    const saved = sessionStorage.getItem('patent_api_key');
    if (saved) {
        API_KEY = saved;
        document.getElementById('apiModal').style.display = 'none';
    }
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Phase Switching
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchPhase(n) {
    document.querySelectorAll('.phase-tab').forEach((t, i) => t.classList.toggle('active', i === n));
    document.querySelectorAll('.phase-content').forEach((c, i) => c.classList.toggle('active', i === n));
    if (n === 4) renderPreview();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Title
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onTitleChange() {
    title = document.getElementById('titleInput').value.trim();
    const confirmed = title.length > 0;
    document.getElementById('titleConfirm').style.display = confirmed ? 'block' : 'none';
    document.getElementById('phase0Steps').style.display = confirmed ? 'block' : 'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Claude API Call
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function callClaude(prompt) {
    const resp = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'x-api-key': API_KEY,
            'anthropic-version': '2023-06-01',
            'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
            model: 'claude-sonnet-4-5-20250929',
            max_tokens: 8192,
            system: SYSTEM_PROMPT,
            messages: [{ role: 'user', content: prompt }]
        })
    });
    const data = await resp.json();
    if (data.error) throw new Error(data.error.message);
    usage.calls++;
    usage.input += (data.usage?.input_tokens || 0);
    usage.output += (data.usage?.output_tokens || 0);
    updateStats();
    return data.content[0].text;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Prompt Builder
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildPrompt(stepId) {
    const proj = document.getElementById('projectText').value;
    const ctx = title ? `[ë°œëª…ì˜ ëª…ì¹­] ${title}` : '';
    const o = outputs;

    const map = {
step_01: `ì•„ë˜ í”„ë¡œì íŠ¸ ë‚´ìš©ì„ ë¶„ì„í•˜ì—¬ íŠ¹í—ˆì¶œì›ì— ì í•©í•œ ë°œëª…ì˜ ëª…ì¹­ í›„ë³´ë¥¼ 4ê°€ì§€ ì¹´í…Œê³ ë¦¬ë¡œ ì œì•ˆí•˜ë¼.
ì¹´í…Œê³ ë¦¬ A: "~ì„œë²„" í˜•íƒœ / B: "~ë°©ë²•" í˜•íƒœ / C: "~ì‹œìŠ¤í…œ" í˜•íƒœ / D: "~ì„œë²„ ë° ë°©ë²•" í˜•íƒœ
ê° í›„ë³´ì— êµ­ë¬¸ê³¼ ì˜ë¬¸ í¬í•¨.
[í”„ë¡œì íŠ¸ ë‚´ìš©]
${proj}`,

step_02: `ê¸°ìˆ ë¶„ì•¼ë¥¼ ì„œìˆ í•˜ë¼. 20ë‹¨ì–´ ë‚´ì™¸ í•œ ë¬¸ì¥. "ë³¸ ë°œëª…ì€"ìœ¼ë¡œ ì‹œì‘, "~ì— ê´€í•œ ê²ƒì´ë‹¤."ë¡œ ëë‚´ë¼. ë°œëª…ì˜ ëª…ì¹­ í¬í•¨.
${ctx}`,

step_03: `ë°°ê²½ê¸°ìˆ ì„ ê¸°ì¬í•˜ë¼. 3ê°œ ë¬¸ë‹¨: (1)ê¸°ì¡´ ë¬¸ì œ (2)ìµœê·¼ ë™í–¥ (3)í•„ìš”ì„±. ê° 150ë‹¨ì–´. ë²ˆí˜¸/ì œëª© ì—†ì´ ë¬¸ë‹¨ë§Œ. ì œí’ˆëª…/íšŒì‚¬ëª… ê¸ˆì§€.
${ctx}
[í”„ë¡œì íŠ¸] ${proj}`,

step_04: `ì„ í–‰ê¸°ìˆ ë¬¸í—Œì„ ì‘ì„±í•˜ë¼.
ã€íŠ¹í—ˆë¬¸í—Œã€‘
(íŠ¹í—ˆë¬¸í—Œ 1) í•œêµ­ë“±ë¡íŠ¹í—ˆ ì œ__________í˜¸ (ì¶”í›„ ë³´ì™„ í•„ìš”)
${ctx}`,

step_05: `í•´ê²°ê³¼ì œë¥¼ ì„œìˆ í•˜ë¼. "ë³¸ ë°œëª…ì€"ìœ¼ë¡œ ì‹œì‘, "~ì„ ì œê³µí•˜ëŠ” ê²ƒì„ ëª©ì ìœ¼ë¡œ í•œë‹¤."ë¡œ ë.
ë§ˆì§€ë§‰ ë¬¸ë‹¨: "ë³¸ ë°œëª…ì˜ ê¸°ìˆ ì  ê³¼ì œëŠ” ì´ìƒì—ì„œ ì–¸ê¸‰í•œ ê¸°ìˆ ì  ê³¼ì œë¡œ ì œí•œë˜ì§€ ì•Šìœ¼ë©°, ì–¸ê¸‰ë˜ì§€ ì•Šì€ ë˜ ë‹¤ë¥¸ ê¸°ìˆ ì  ê³¼ì œë“¤ì€ ì•„ë˜ì˜ ê¸°ì¬ë¡œë¶€í„° ë‹¹ì—…ìì—ê²Œ ëª…í™•í•˜ê²Œ ì´í•´ë  ìˆ˜ ìˆì„ ê²ƒì´ë‹¤."
${ctx}
[ë°°ê²½ê¸°ìˆ ] ${o.step_03 || ''}`,

step_06: `ì¥ì¹˜ ì²­êµ¬ë²”ìœ„ë¥¼ ì‘ì„±í•˜ë¼. ë…ë¦½í•­1 + ì¢…ì†í•­5ê°œë‚´ì™¸. ì¢…ì†í•­ì€ "ì²­êµ¬í•­ 1ì— ìˆì–´ì„œ"ë¡œ ì‹œì‘. ì¶œë ¥: ã€ì²­êµ¬í•­ 1ã€‘... ã€ì²­êµ¬í•­ 2ã€‘... í˜•ì‹.
${ctx}
[í”„ë¡œì íŠ¸] ${proj}`,

step_07: `ì²­êµ¬ë²”ìœ„ ì„¤ëª… ë„ë©´ì„ ì„¤ê³„í•˜ë¼. ê° ë„ë©´: ì œëª©/ìœ í˜•, êµ¬ì„±ìš”ì†Œ+ì°¸ì¡°ë²ˆí˜¸, ì—°ê²°ê´€ê³„, ê°„ë‹¨í•œì„¤ëª…. ì°¸ì¡°ë²ˆí˜¸: ì„œë²„100ë²ˆëŒ€, ë‹¨ë§200ë²ˆëŒ€, ì™¸ë¶€300ë²ˆëŒ€.
${ctx}
[ì²­êµ¬ë²”ìœ„] ${o.step_06 || ''}`,

step_08: `ìƒì„¸ì„¤ëª…ì„ ì‘ì„±í•˜ë¼. ì„œë²„(100) ì£¼ì–´. "êµ¬ì„±ìš”ì†Œ(ì°¸ì¡°ë²ˆí˜¸)" í˜•íƒœ. ë„ë©´ë³„ ì„¤ëª…. íŠ¹í—ˆë¬¸ì²´(~í•œë‹¤). ê¸€ë¨¸ë¦¬ê¸ˆì§€. ì²­êµ¬í•­ ëª¨ë“  êµ¬ì„±ìš”ì†Œ í¬í•¨.
${ctx}
[ì²­êµ¬ë²”ìœ„] ${o.step_06 || ''}
[ë„ë©´ì„¤ê³„] ${o.step_07 || ''}
[í”„ë¡œì íŠ¸] ${(proj || '').substring(0, 3000)}`,

step_09: `ìˆ˜í•™ì‹ 5ê°œ ë‚´ì™¸. ã€ìˆ˜í•™ì‹ Nã€‘, ìˆ˜ì‹ë³¸ë¬¸, íŒŒë¼ë¯¸í„°ì •ì˜, ì˜ˆì‹œëŒ€ì…. ì‚½ì…ìœ„ì¹˜ ì§€ì •. ì‹¤ì œ ê¸°ìˆ  ì •í™•íˆ í‘œí˜„.
${ctx}
[ìƒì„¸ì„¤ëª…] ${(o.step_08 || '').substring(0, 5000)}`,

step_10: `ë°©ë²• ì²­êµ¬í•­. ë…ë¦½í•­1 + ì¢…ì†í•­9ê°œë‚´ì™¸. "~ë‹¨ê³„"ë¡œ ê¸°ìˆ . ì¥ì¹˜ ì²­êµ¬í•­ ë²ˆí˜¸ì— ì´ì–´ì„œ. ã€ì²­êµ¬í•­ Nã€‘ í˜•íƒœ.
${ctx}
[ì¥ì¹˜ ì²­êµ¬í•­] ${o.step_06 || ''}
[ìƒì„¸ì„¤ëª…] ${(o.step_08 || '').substring(0, 3000)}`,

step_11: `ë°©ë²• íë¦„ë„ ì„¤ê³„. ë„ë©´ë¶€í˜¸ S100,S200... ê° ë‹¨ê³„: ë²ˆí˜¸,ë‚´ìš©,ì—°ê²°. ê°„ë‹¨í•œì„¤ëª… í¬í•¨.
${ctx}
[ë°©ë²• ì²­êµ¬í•­] ${o.step_10 || ''}`,

step_12: `ë°©ë²• ìƒì„¸ì„¤ëª…. ë‹¨ê³„ìˆœì„œëŒ€ë¡œ ì¥ì¹˜ë™ì‘ê³¼ 1:1 ëŒ€ì‘. íŠ¹í—ˆë¬¸ì²´. ê¸€ë¨¸ë¦¬ê¸ˆì§€.
ì‹œì‘: "ì´í•˜ì—ì„œëŠ” ì•ì„œ ì„¤ëª…í•œ ì„œë²„ì˜ êµ¬ì„± ë° ë™ì‘ì„ ì°¸ì¡°í•˜ì—¬ ë°©ë²•ì„ ì„¤ëª…í•œë‹¤."
${ctx}
[ë°©ë²• ì²­êµ¬í•­] ${o.step_10 || ''}
[ë°©ë²• ë„ë©´] ${o.step_11 || ''}
[ì¥ì¹˜ ìƒì„¸ì„¤ëª…] ${(o.step_08 || '').substring(0, 3000)}`,

step_13: `ëª…ì„¸ì„œ ê²€í† . 1.ì²­êµ¬í•­ ë’·ë°›ì¹¨ ê²€í†  2.ê¸°ìˆ ì ë¹„ì•½ íŒŒì•…. ê° ë³´ì¶©/ë³´ì™„ë‚´ìš© ì‘ì„±.
${ctx}
[ì²­êµ¬ë²”ìœ„] ${o.step_06 || ''}\n${o.step_10 || ''}
[ìƒì„¸ì„¤ëª…] ${(o.step_08 || '').substring(0, 6000)}`,

step_14: `ëŒ€ì•ˆ ì²­êµ¬í•­. í•µì‹¬ ìœ ì§€í•˜ë˜ í‘œí˜„ ë‹¬ë¦¬í•˜ë¼. ã€ì²­êµ¬í•­ Nã€‘ í˜•íƒœ.
${ctx}
[ì¥ì¹˜ ì²­êµ¬í•­] ${o.step_06 || ''}
[ë°©ë²• ì²­êµ¬í•­] ${o.step_10 || ''}`,

step_15: `ê¸°ì¬ë¶ˆë¹„ ê²€ì‚¬. (a)ìƒê¸° ì„ í–‰ê¸°ì¬ (b)ìš©ì–´ì¼ê´€ì„± (c)êµ¬ì„±ìš”ì†ŒëŒ€ì‘ (d)í•„ìˆ˜êµ¬ì„±ëˆ„ë½. ìˆ˜ì •ì•ˆ ì œì‹œ.
${ctx}
[ì „ì²´ ì²­êµ¬ë²”ìœ„] ${o.step_06 || ''}\n${o.step_10 || ''}\n${o.step_14 || ''}`,

step_16: `ë°œëª…ì˜ íš¨ê³¼. "ë³¸ ë°œëª…ì— ë”°ë¥´ë©´,"ìœ¼ë¡œ ì‹œì‘. ë§ˆì§€ë§‰: "ë³¸ ë°œëª…ì˜ íš¨ê³¼ëŠ” ì´ìƒì—ì„œ ì–¸ê¸‰í•œ íš¨ê³¼ë¡œ ì œí•œë˜ì§€ ì•Šìœ¼ë©°..."
${ctx}
[ê³¼ì œ] ${o.step_05 || ''}
[ìƒì„¸ì„¤ëª…] ${(o.step_08 || '').substring(0, 2000)}`,

step_17: `ê³¼ì œì˜ í•´ê²° ìˆ˜ë‹¨. "ë³¸ ë°œëª…ì˜ ì¼ ì‹¤ì‹œì˜ˆì— ë”°ë¥¸"ìœ¼ë¡œ ì‹œì‘. ë§ˆì§€ë§‰: "ë³¸ ë°œëª…ì˜ ê¸°íƒ€ êµ¬ì²´ì ì¸ ì‚¬í•­ë“¤ì€ ìƒì„¸í•œ ì„¤ëª… ë° ë„ë©´ë“¤ì— í¬í•¨ë˜ì–´ ìˆë‹¤."
${ctx}
[ì¥ì¹˜ ì²­êµ¬í•­] ${o.step_06 || ''}
[ë°©ë²• ì²­êµ¬í•­] ${o.step_10 || '(ì—†ìŒ)'}`,

step_18: `ë„ë©´ ë¶€í˜¸ ì„¤ëª…. "êµ¬ì„±ìš”ì†Œ : ì°¸ì¡°ë²ˆí˜¸" í˜•íƒœ. ì°¸ì¡°ë²ˆí˜¸ìˆœ ì •ë ¬.
${ctx}
[ë„ë©´ì„¤ê³„] ${o.step_07 || ''}
[ë°©ë²•ë„ë©´] ${o.step_11 || ''}`,

step_19: `ìš”ì•½ì„œ. ì²­êµ¬í•­1 ê¸°ì¤€ 150ë‹¨ì–´ ë‚´ì™¸. ëª©ì /êµ¬ì„±/íš¨ê³¼. "ë³¸ ë°œëª…ì€"ìœ¼ë¡œ ì‹œì‘.
${ctx}
[ì²­êµ¬í•­ 1] ${(o.step_06 || '').substring(0, 1500)}`
    };
    return map[stepId] || '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Run Step
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function runStep(stepId) {
    if (loadingSteps[stepId]) return;
    loadingSteps[stepId] = true;
    updateButtonState(stepId, true);

    try {
        const prompt = buildPrompt(stepId);
        const result = await callClaude(prompt);
        outputs[stepId] = result;
        renderStepOutput(stepId);
    } catch(e) {
        alert(`ì˜¤ë¥˜: ${e.message}`);
    } finally {
        loadingSteps[stepId] = false;
        updateButtonState(stepId, false);
    }
}

async function runBatch(stepIds) {
    for (const sid of stepIds) {
        await runStep(sid);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI Helpers
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateButtonState(stepId, loading) {
    const btn = document.getElementById(`btn_${stepId}`);
    if (btn) {
        if (loading) {
            btn.disabled = true;
            btn._origText = btn.textContent;
            btn.textContent = 'â³ ìƒì„± ì¤‘...';
        } else {
            btn.disabled = false;
            btn.textContent = btn._origText || 'ğŸ¤– ìƒì„±';
        }
    }
}

function updateStats() {
    const completed = Object.keys(outputs).filter(k => outputs[k] && !outputs[k].startsWith('[ì˜¤ë¥˜]')).length;
    document.getElementById('statComplete').textContent = `${completed}/19`;
    document.getElementById('statCalls').textContent = usage.calls;
    const cost = ((usage.input * 3) / 1e6 + (usage.output * 15) / 1e6).toFixed(3);
    document.getElementById('statCost').textContent = `$${cost}`;
}

function createCollapsible(title, content, container, badge) {
    const id = 'c_' + Math.random().toString(36).substr(2, 6);
    const html = `
        <div class="collapse-header" onclick="document.getElementById('${id}').style.display = document.getElementById('${id}').style.display === 'none' ? 'block' : 'none'">
            <span>â–¶ ${title}</span>
            ${badge ? `<span class="badge">${badge}</span>` : ''}
        </div>
        <div class="collapse-body" id="${id}" style="display:none;">
            <textarea rows="8" style="width:100%;" onchange="outputs['${container}'] = this.value">${escapeHtml(content)}</textarea>
        </div>`;
    return html;
}

function escapeHtml(text) {
    if (!text) return '';
    return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

function renderStepOutput(stepId) {
    const content = outputs[stepId];
    if (!content) return;

    // Step 1: title candidates
    if (stepId === 'step_01') {
        const el = document.getElementById('output_step_01_preview');
        el.textContent = content;
        el.style.display = 'block';
        return;
    }

    // Step 6: claims with stats
    if (stepId === 'step_06') {
        renderClaimStats();
        renderEditArea('step06_edit', 'step_06', content, 12);
        return;
    }

    // Steps with dedicated edit areas
    const editAreas = {
        step_07: 'step07_edit', step_10: 'step10_edit'
    };
    if (editAreas[stepId]) {
        renderEditArea(editAreas[stepId], stepId, content, 10);
        return;
    }

    // Steps with collapsible sections
    const sectionMap = {
        step_02: 'step02_section', step_03: 'step03_section',
        step_04: 'step04_section', step_05: 'step05_section',
        step_08: 'step08_section', step_09: 'step09_section',
        step_11: 'step11_section', step_12: 'step12_section',
        step_13: 'step13_section', step_14: 'step14_section',
        step_15: 'step15_section', step_16: 'step16_section',
        step_17: 'step17_section', step_18: 'step18_section',
        step_19: 'step19_section'
    };

    const targetId = sectionMap[stepId];
    if (targetId) {
        const el = document.getElementById(targetId);
        if (el) {
            el.innerHTML = createCollapsible(
                STEP_NAMES[stepId],
                content, stepId,
                `${content.length}ì`
            );
        }
    }

    updateStats();
}

function renderEditArea(containerId, stepId, content, rows) {
    const el = document.getElementById(containerId);
    if (el) {
        el.innerHTML = `<textarea rows="${rows}" style="width:100%;" onchange="outputs['${stepId}'] = this.value">${escapeHtml(content)}</textarea>`;
    }
}

function renderClaimStats() {
    const text = outputs.step_06 || '';
    const matches = text.match(/ã€ì²­êµ¬í•­\s*\d+ã€‘/g) || [];
    const total = matches.length;
    let dep = 0;
    const cp = /ã€ì²­êµ¬í•­\s*(\d+)ã€‘\s*([\s\S]*?)(?=ã€ì²­êµ¬í•­\s*\d+ã€‘|$)/g;
    let m;
    while ((m = cp.exec(text)) !== null) {
        if (/ìˆì–´ì„œ|ë”°ë¥¸/.test(m[2])) dep++;
    }

    document.getElementById('claimStats').style.display = 'flex';
    document.getElementById('claimStats').innerHTML = `
        <div class="stats" style="margin:0; width:100%;">
            <div class="stat-box bg1"><div class="num">${total}</div><div class="lbl">ì´ ì²­êµ¬í•­</div></div>
            <div class="stat-box" style="background:#2E7D32;"><div class="num">${total - dep}</div><div class="lbl">ë…ë¦½í•­</div></div>
            <div class="stat-box" style="background:#1565C0;"><div class="num">${dep}</div><div class="lbl">ì¢…ì†í•­</div></div>
        </div>`;

    // Validation
    const issues = validateClaims(text);
    const valEl = document.getElementById('claimValidation');
    if (issues.length === 0) {
        valEl.innerHTML = '<div class="issue pass">âœ… ê¸°ì¬ë¶ˆë¹„ ìë™ ê²€ì¦ í†µê³¼</div>';
    } else {
        valEl.innerHTML = issues.map(i =>
            `<div class="issue ${i.severity.toLowerCase()}">${i.severity === 'CRITICAL' ? 'ğŸ”´' : 'ğŸŸ '} ${i.msg}</div>`
        ).join('');
    }
}

function validateClaims(text) {
    const issues = [];
    if (!text) return issues;
    const claims = {};
    const cp = /ã€ì²­êµ¬í•­\s*(\d+)ã€‘\s*([\s\S]*?)(?=ã€ì²­êµ¬í•­\s*\d+ã€‘|$)/g;
    let m;
    while ((m = cp.exec(text)) !== null) claims[parseInt(m[1])] = m[2].trim();
    if (Object.keys(claims).length === 0) {
        issues.push({ severity: 'HIGH', msg: 'ì²­êµ¬í•­ íŒŒì‹± ì‹¤íŒ¨' });
        return issues;
    }
    if (!claims[1]) issues.push({ severity: 'CRITICAL', msg: 'ë…ë¦½í•­(ì²­êµ¬í•­ 1) ì—†ìŒ' });

    Object.entries(claims).forEach(([num, text]) => {
        if (parseInt(num) === 1) return;
        const refs = text.match(/ìƒê¸°\s+([ê°€-í£a-zA-Z]+(?:\s[ê°€-í£a-zA-Z]+)*)/g) || [];
        refs.forEach(ref => {
            const term = ref.replace(/^ìƒê¸°\s+/, '');
            if (claims[1] && !claims[1].includes(term)) {
                const rc = text.match(/ì²­êµ¬í•­\s*(\d+)ì—\s*ìˆì–´ì„œ/);
                const rn = rc ? parseInt(rc[1]) : 1;
                if (!claims[rn] || !claims[rn].includes(term)) {
                    issues.push({ severity: 'CRITICAL', msg: `ì²­êµ¬í•­ ${num}: 'ìƒê¸° ${term}' ì„ í–‰ê¸°ì¬ ì—†ìŒ` });
                }
            }
        });
    });
    return issues;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Preview & Export
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildFullSpec() {
    const sections = [
        ['ë°œëª…ì˜ ì„¤ëª…', ''],
        ['ë°œëª…ì˜ ëª…ì¹­', title],
        ['ê¸°ìˆ ë¶„ì•¼', outputs.step_02],
        ['ë°œëª…ì˜ ë°°ê²½ì´ ë˜ëŠ” ê¸°ìˆ ', outputs.step_03],
        ['ì„ í–‰ê¸°ìˆ ë¬¸í—Œ', outputs.step_04],
        ['ë°œëª…ì˜ ë‚´ìš©', ''],
        ['í•´ê²°í•˜ê³ ì í•˜ëŠ” ê³¼ì œ', outputs.step_05],
        ['ê³¼ì œì˜ í•´ê²° ìˆ˜ë‹¨', outputs.step_17],
        ['ë°œëª…ì˜ íš¨ê³¼', outputs.step_16],
        ['ë„ë©´ì˜ ê°„ë‹¨í•œ ì„¤ëª…', outputs.step_07],
        ['ë°œëª…ì„ ì‹¤ì‹œí•˜ê¸° ìœ„í•œ êµ¬ì²´ì ì¸ ë‚´ìš©', [outputs.step_08, outputs.step_09, outputs.step_12].filter(Boolean).join('\n\n')],
        ['ì²­êµ¬ë²”ìœ„', [outputs.step_06, outputs.step_10].filter(Boolean).join('\n\n')],
        ['ìš”ì•½ì„œ', outputs.step_19],
        ['ë„ë©´ì˜ ì£¼ìš” ë¶€ë¶„ì— ëŒ€í•œ ë¶€í˜¸ì˜ ì„¤ëª…', outputs.step_18],
    ];
    return sections
        .filter(([, v]) => v !== undefined)
        .map(([name, content]) => `ã€${name}ã€‘\n${content || ''}`)
        .join('\n\n');
}

function copyFullSpec() {
    navigator.clipboard.writeText(buildFullSpec()).then(() => alert('âœ… ì „ì²´ ëª…ì„¸ì„œê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.'));
}

function downloadAsText() {
    const blob = new Blob([buildFullSpec()], { type: 'text/plain;charset=utf-8' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `íŠ¹í—ˆëª…ì„¸ì„œ_${title || 'ì´ˆì•ˆ'}_${new Date().toISOString().slice(0,10)}.txt`;
    a.click();
}

function renderPreview() {
    const area = document.getElementById('previewArea');
    const sections = [
        ['ë°œëª…ì˜ ëª…ì¹­', title], ['ê¸°ìˆ ë¶„ì•¼', outputs.step_02],
        ['ë°°ê²½ê¸°ìˆ ', outputs.step_03], ['ì„ í–‰ê¸°ìˆ ë¬¸í—Œ', outputs.step_04],
        ['í•´ê²°í•˜ê³ ì í•˜ëŠ” ê³¼ì œ', outputs.step_05], ['ê³¼ì œì˜ í•´ê²° ìˆ˜ë‹¨', outputs.step_17],
        ['ë°œëª…ì˜ íš¨ê³¼', outputs.step_16], ['ë„ë©´ ì„¤ê³„', outputs.step_07],
        ['ì¥ì¹˜ ìƒì„¸ì„¤ëª…', outputs.step_08], ['ìˆ˜í•™ì‹', outputs.step_09],
        ['ë°©ë²• ìƒì„¸ì„¤ëª…', outputs.step_12], ['ì¥ì¹˜ ì²­êµ¬í•­', outputs.step_06],
        ['ë°©ë²• ì²­êµ¬í•­', outputs.step_10], ['ëŒ€ì•ˆ ì²­êµ¬í•­', outputs.step_14],
        ['ìš”ì•½ì„œ', outputs.step_19], ['ë„ë©´ ë¶€í˜¸', outputs.step_18],
    ].filter(([, v]) => v);

    area.innerHTML = sections.map(([name, content]) =>
        createCollapsible(`ã€${name}ã€‘`, content, '', `${content.length}ì`)
    ).join('');

    // Usage summary
    const cost = ((usage.input * 3) / 1e6 + (usage.output * 15) / 1e6).toFixed(3);
    document.getElementById('usageSummary').innerHTML =
        `í˜¸ì¶œ: ${usage.calls}íšŒ | ì…ë ¥: ${usage.input.toLocaleString()} í† í° | ì¶œë ¥: ${usage.output.toLocaleString()} í† í° | ì˜ˆìƒ ë¹„ìš©: $${cost}`;
}
</script>

</body>
</html>
